<% transactionType = (local_assigns[:txType]) ? txType : 'expense' %>
<% categoryAccountType = transactionType == 'expense' ? 'acct_id_dr' : 'acct_id_cr' %>
<% txAccountType = transactionType == 'expense' ? 'acct_id_cr' : 'acct_id_dr' %>
<% txAmountToUpdate = transactionType == 'expense' ? 'debit' : 'credit' %>
<% txAmountSortColumn = (local_assigns[:txAmountSort]) ? txAmountSort : 'credit' %>

<table id="transactions" class="table table-striped table-condensed">
	<tr>
		<th width="120px"><%= sortable "tx_date", "Date" %></th>
		<th><%= sortable "account_id", "Account" %></th>
		<th><%= sortable "details" %></th>
		<th><%= sortable "notes" %></th>
		<th class="text-center" width="75px"><%= sortable txAmountSortColumn, "Amount" %></th>
		<th>Category</th>
		<th>Suggested</th>
		<th width="48" class="text-center">Details</th>
	</tr>

<% tabIndex = 1%>

<% @transactions.each_with_index do |transaction, idx| %>
	<% txAmountClass = transaction.respond_to?(:txType) ? transaction.txType :  'credit'%>
	<% has_acct_dr_proposed = false%>
	<% tabIndex = tabIndex+4%>
	<% tx_dr_id = transaction.acct_id_dr %>
	<% if transaction.acct_id_dr.nil? && !transaction.acct_id_dr_proposed.nil? %>
		<% has_acct_dr_proposed = true %>
		<% tx_dr_proposed = Hash[transaction.acct_id_dr_proposed.tr("{} ", "").split(',').map { |pair| pair.split('=>') }] %>
	<% end %>
	<tr>
		<td class="tx align-middle"><%= best_in_place transaction, :tx_date, :as => :date, :display_as => :format_date %></td>
		<td class="tx align-middle"><%= form_for transaction, :remote => true do |f| %>
				<%= f.select txAccountType, options_from_collection_for_select(@user.sortedAccounts,'id','name', transaction[txAccountType]), {}, :class => 'transaction_update select', tabindex: "-1" %>
			<% end %>
		</td>
		<td class="tx align-middle"><%= best_in_place transaction, :details, :as => :textarea %></td>
		<td class="tx align-middle"><%= best_in_place transaction, :notes, :class => 'expense_note', tabindex: tabIndex %></td>
		<td class="text-center tx align-middle <%= txAmountClass %>"><%= number_to_currency(transaction.amount) %></td>
		<td class="tx align-middle" style="width: 1px; white-space: nowrap;"><%= form_for transaction, :remote => true do |f| %>
			<%= f.hidden_field txAmountToUpdate, value: [transaction.debit.to_f, transaction.credit.to_f].max() %>
			<%= f.hidden_field categoryAccountType + "_proposed", value: nil %>
			<%= f.select categoryAccountType, options_from_collection_for_select(@user.sortedAccounts,'id','name', transaction[categoryAccountType]), { :include_blank => "select type"},
				:id => categoryAccountType + '-' + transaction.id.to_s, :class => 'transaction_update select', tabindex: tabIndex+1 %>
		<% end %>
		</td>
		<td class="tx align-middle align-left">
			<% if has_acct_dr_proposed %>
				<% tx_dr_proposed.each_with_index do |(k,v),idx|%>
					<% certainty = v.to_f > 0.9 ? "success" : "info"%>
					<%= form_for transaction, :remote => true, :class => 'float:right' do |f| %>
						<span id=<%= categoryAccountType + "-" + transaction.id.to_s + "-" + k.to_s %>
							class="badge <%= "badge-" + certainty %> transaction_pill"
							tabindex=<%=tabIndex+2%>>
							<%= @user.sortedAccounts.find { |account| account.id == tx_dr_proposed.keys[idx].to_i }.name %>
						</span>
						<%= f.hidden_field categoryAccountType, value: tx_dr_proposed.keys[idx] %>
						<%= f.hidden_field categoryAccountType + "_proposed", value: nil %>
						<input type="hidden" name="page" value="<%=params[:page]%>">
					<%end%>
				<%end%>
			<% end %>
		</td>

		<td class="text-center tx align-middle">
			<div class="d-flex justify-content-between">
				<div class="dropdown">
					<a class="btn btn-sm" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						...
					</a>
					<div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
						<a class="dropdown-item" href="<%= edit_transaction_path(:id => transaction.id)%>">Edit</a>
						<a class="dropdown-item" href="<%= transaction_path(:id => transaction.id)%>">View</a>
						<% if transactionType == 'expense'%>
							<a class="dropdown-item" href="<%= split_expenses_path(:id => transaction.id)%>">Split</a>
						<% end %>
						<% if transaction[:attachments] == 0 %>
							<%= link_to( "Add Attachment", transaction_new_attachment_path(:transaction_id => transaction.id), {:remote => true, 'data-toggle' => 'modal', 'data-backdrop'=>'static','data-target' => '#modal-window', class: "dropdown-item"})  %>
						<% end %>
						<%= link_to( "Delete", transaction, method: :delete, data: { confirm: 'Delete Transaction?' }, class: "dropdown-item") %>
					</div>
				</div>
				<div class="dropdown d-flex justify-content-between">
					<div class="float-start">
						<% if transaction[:attachments] > 0 %>
							<a href="#" id="attachmentDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<%= image_tag("attachment.png", height: '16', width: '16') %>
							</a>
							<div class="dropdown-menu dropdown-menu-right" aria-labelledby="attachmentDropdownMenuButton">
								<%= link_to( "Show Attachment", url_for(transaction.attachment), class: "dropdown-item" ) %>
								<%= link_to( 'Delete Attachment', transaction_delete_attachment_url(transaction),
									method: :delete,
									class: "dropdown-item",
									data: { confirm: 'Are you sure?' }) %>
							</div>
						<% end %>
					</div>
					<div>
						<% if !transaction.parent_id.nil? %>
							<a href="#" id="connectedDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<%= image_tag("connected.png", height: '16', width: '16') %>
							</a>
							<div class="dropdown-menu dropdown-menu-right" aria-labelledby="connectedDropdownMenuButton">
								<%= link_to( "Show Related", transaction_path(:id => transaction.parent_id), class: "dropdown-item" ) %>
							</div>
						<% else %>
							<%= image_tag("empty.png", height: '16', width: '16') %>
						<% end %>

					</div>
				</div>
			</div>
		</td>
	</tr>
<% end %>
</table>

<div id="modal-window" class="modal hide" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"></div>