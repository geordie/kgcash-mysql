<script type="text/javascript">

var tableData = <%= local_assigns[:gonData] %>;

var columns = [
    { head: 'Category' },
    { head: 'Jan' },
    { head: 'Feb' },
    { head: 'Mar' },
    { head: 'Apr' },
    { head: 'May' },
    { head: 'Jun' },
    { head: 'Jul' },
    { head: 'Aug' },
    { head: 'Sep' },
    { head: 'Oct' },
    { head: 'Nov' },
    { head: 'Dec' },
    { head: 'Total' },
    { head: 'Monthly' },
    { head: 'Daily'}
];

var domId = "<%= local_assigns[:domId] ? "#" + domId : "#chartStacked" %>";
var year = "<%= local_assigns[:year] ? year : 2019 %>"
var linkURLPath = "<%= local_assigns[:linkURLPath] ? linkURLPath : "../expenses" %>"

var table = d3.select(domId)
  .attr('class', 'table table-striped table-condensed')
  .append("table");

 // create table header
table.append('thead').append('tr')
  .selectAll('th')
  .data(columns).enter()
  .append('th')
  .attr('class', 'text-center')
  .text(function(d){return d.head;});

var catId = 0;

// create table body
table.append('tbody')
  .selectAll('tr')
  .data(tableData)
  .enter()
  .append('tr')
  .selectAll('td')
  .data(expandMonths)
  .enter()
  .append('td')
  .attr('class', 'text-center')
  .append('a')
  .attr("href", buildHref)
  .html(function(d,i){
      if(i==0){
        return d.cat_name;
      }
      else if(i<13){
        return "$" + d3.format(",.0f")(d);
      }
    }
  );

  // Add column for total amount
  addColumn(table, "total");

  // Add column for monthly amount
  addColumn(table, "monthly");

  // Add column for daily amount
  addColumn(table, "daily");

  // This function pulls the months array out of the input data and
  // makes it a sibling of the hash in which it was originally contained.
  // This step makes the month step avaible as data for presenting as table
  // cells by D3.
  function expandMonths(data, idx){
    return data.concat(data[0].months);
  }

  function buildHref(d,i){
    if(i==0){
      catId=d.cat_id;
      return null;
    }
    // This is a poor, indirect way to check for the Totals row.
    // And we won't set href for the Totals row.
    if( catId == 0)
    {
      return null;
    }
    return linkURLPath + "?month=" + i + "&category=" + catId + "&year=" + year;
  }

  function addColumn(element, index) {
    element
    .selectAll('tr')
    .append('td')
    .attr('class', 'text-center')
    .html(function(d,i){
        // Ignore the header row by requiring i > 0
        if ( i > 0 ){
          return "$" + d3.format(",.0f")(d[0][index]);
        }
      }
    )    
  }


</script>